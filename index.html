<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- NOVO: Meta Tag de Verifica√ß√£o do Google AdSense -->
  <meta name="google-adsense-account" content="ca-pub-2957847231347233">
  
  <!-- IN√çCIO: INTEGRA√á√ÉO GOOGLE ADSENSE (C√ìDIGO DE AUTO ADS INSERIDO) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2957847231347233" crossorigin="anonymous"></script>
  <!-- FIM: INTEGRA√á√ÉO GOOGLE ADSENSE -->
  
  <!-- Content Security Policy: Garantindo que todos os recursos externos (CDNs e AdSense) sejam carregados via HTTPS -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://cdn.tailwindcss.com https://cdnjs.cloudflare.com https://pagead2.googlesyndication.com 'unsafe-inline'; style-src 'self' https://fonts.googleapis.com 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https://raw.githubusercontent.com https://github.com https://placehold.co; media-src 'self' blob:;">
  <title>Analisador de Compatibilidade pelos P√©s - By Irmo Zuccato Neto</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* Esconde todos os containers por padr√£o */
    #app-header-container, .result-container, .step-container { 
        display: none;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
        position: absolute;
        width: 100%;
    }
    .active-block { 
        display: block;
        opacity: 1;
        transform: translateY(0);
        position: relative;
    }
    .step-container.hiding {
        opacity: 0;
        transform: translateY(-20px);
        pointer-events: none;
    }
    .custom-cursor { cursor: crosshair; }
    .bg-animation {
      background-color: #f0f9ff;
      background-image: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%);
    }
    .result-perfect { color: #10b981; } /* Green */
    .result-very-close { color: #f59e0b; } /* Amber */
    .result-close { color: #fb7185; } /* Pink */
    .result-far { color: #ef4444; } /* Red */

    /* Estilo para a notifica√ß√£o de c√≥pia */
    #copy-notification {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: #2f3640;
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.4s ease-in-out, transform 0.4s ease-in-out;
        pointer-events: none;
        transform: translate(-50%, 20px);
    }
    #copy-notification.show {
        opacity: 1;
        transform: translate(-50%, 0);
    }
    
    /* Estilo para Impress√£o e PDF */
    @media print {
        body, html {
            background-color: white;
        }
        body * {
            visibility: hidden;
        }
        #comparison-report-block, #comparison-report-block * {
            visibility: visible;
        }
        #comparison-report-block {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            border: none;
            box-shadow: none;
            margin: 0;
            padding: 0;
        }
        .action-buttons, .ads-container {
            display: none;
        }
        .pdf-page-break-after {
            page-break-after: always;
        }
    }
    
    /* Estilo para o Loading Spinner (adicionado) */
    .loading-spinner {
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 4px solid #fff;
        width: 1.5rem;
        height: 1.5rem;
        animation: spin 1s linear infinite;
        margin-left: 0.5rem;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-animation min-h-screen p-4 sm:p-8 text-gray-800 flex items-center justify-center">

  <!-- Ajuste de margin bottom, n√£o precisamos mais do mb-20 -->
  <div id="app-main-content" class="max-w-4xl w-full mx-auto block-transition mb-8 sm:mb-8">
    <!-- T√≠tulo/Header -->
    <div id="app-header-container">
        <header class="text-center mb-6 sm:mb-10">
          <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 mb-2">AN√ÅLISE DE "MATCH" PELOS P√âS</h1>
          <p class="text-base sm:text-xl text-gray-600">By IRMO ZUCCATO NETO</p>
        </header>
    </div>

    <!-- Tela Inicial -->
    <div id="splash-screen" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-dashed border-blue-300 text-center transition-all duration-300 active-block">
      
      <img src="https://raw.githubusercontent.com/irmoneto/Analisador-Personalidade-Pelos-P-s/main/IMAGENS%20APP/LOGO.jpg" alt="Logo do Irmo Zuccato Neto" class="mx-auto mb-6 rounded-full shadow-lg" style="max-width: 150px; height: auto;">
      
      <h2 class="text-xl sm:text-2xl font-bold mb-4">AN√ÅLISE DE "MATCH" PELOS P√âS</h2>
      <p class="text-lg sm:text-xl text-gray-700 mb-8">Descubra os pontos fortes e desafios na rela√ß√£o entre duas pessoas a partir dos seus p√©s.</p>
      <button id="start-button" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:from-blue-600 hover:to-blue-700 cursor-pointer transition-transform duration-200 transform hover:scale-105">
        Come√ßar An√°lise Dupla
      </button>
      <p class="text-xs text-gray-500 mt-4">
        Ao continuar, voc√™ concorda com os <a href="#" id="open-terms-splash" class="text-blue-600 hover:text-blue-800 underline font-medium">Termos de Uso</a>.
      </p>
    </div>

    <!-- Bloco de Personaliza√ß√£o (Coleta dos 2 Nomes) -->
    <div id="personalization-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-dashed border-gray-300 text-center transition-all duration-300 step-container">
        
        <div class="flex flex-col sm:flex-row items-center justify-center sm:mb-6 mb-4">
            <img src="https://raw.githubusercontent.com/irmoneto/Analisador-Personalidade-Pes/main/IMAGENS%20APP/LOGO%20OLA.png" 
                 alt="Logo de Boas-Vindas" 
                 class="shadow-md sm:mr-4 mx-auto mb-4 sm:mb-0" 
                 style="width: 150px; height: 100px; max-width: 150px; border-radius: 10px;">
            
            <h2 class="text-xl sm:text-2xl font-semibold text-gray-800">QUEM EST√Å NESSA RELA√á√ÉO?</h2>
        </div>
        
        <div class="mb-6 text-left">
            <label for="name-p1-input" class="block text-gray-700 font-semibold mb-2">Nome da Pessoa 1:</label>
            <input type="text" id="name-p1-input" placeholder="Ex: Jo√£o" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>

        <div class="mb-6 text-left">
            <label for="name-p2-input" class="block text-gray-700 font-semibold mb-2">Nome da Pessoa 2:</label>
            <input type="text" id="name-p2-input" placeholder="Ex: Maria" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
        </div>

        <button id="continue-to-upload" class="bg-teal-500 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-teal-600 cursor-pointer transition-transform duration-200 transform hover:scale-105">
          Prosseguir para An√°lise do P√© 1
        </button>
        <p id="personalization-error" class="text-red-500 text-sm mt-4 hidden">Por favor, preencha os nomes de Pessoa 1 e Pessoa 2.</p>
        <p class="text-xs text-gray-500 mt-6">
            Leia os <a href="#" id="open-terms-personalization" class="text-blue-600 hover:text-blue-800 underline font-medium">Termos Legais</a> completos antes de continuar.
        </p>
    </div>
    
    <!-- Bloco de Upload (Adapta√ß√£o para Pessoa 1 ou 2) -->
    <div id="upload-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-dashed border-gray-300 text-center transition-all duration-300 step-container">
        <h2 class="text-xl sm:text-2xl font-semibold mb-4">Adicione uma foto do p√© de <span id="target-name-display" class="text-blue-600"></span></h2>
        <p class="text-gray-500 mb-6">A foto deve ser clara, de boa qualidade, tirada de cima e de frente.</p>
        <img src="https://raw.githubusercontent.com/irmoneto/Analisador-Personalidade-Pelos-P-s/main/IMAGENS%20APP/EXEMPLO%2002.PNG" alt="Exemplo de foto para upload" class="mx-auto rounded-lg shadow-md mb-6 w-full max-w-sm h-auto">
        
        <div class="flex flex-col sm:flex-row justify-center gap-4">
            <!-- C√¢mera Nativa (Mobile) -->
            <label for="native-camera-input" id="open-camera-button-label" class="bg-blue-500 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-blue-600 transition-colors cursor-pointer inline-flex items-center justify-center mobile-only">
                üì∏ Tirar Foto (C√¢mera Nativa)
                <input type="file" id="native-camera-input" accept="image/*" class="hidden" capture="environment">
            </label>
            
            <label for="image-upload" class="bg-teal-500 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-teal-600 cursor-pointer transition-colors inline-flex items-center justify-center">
                üìÅ Fazer Upload
                <input type="file" id="image-upload" accept="image/*" class="hidden">
            </label>
        </div>
        <p id="camera-error" class="text-red-500 text-sm mt-4 hidden"></p>
    </div>

    <!-- Bloco de Confirma√ß√£o da Foto Capturada -->
    <div id="preview-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg text-center transition-all duration-300 step-container">
        <h2 class="text-xl sm:text-2xl font-semibold mb-4">Confirme a Foto para <span id="preview-target-name" class="text-blue-600"></span></h2>
        <img id="photo-preview" src="" alt="Foto capturada" class="mx-auto rounded-lg shadow-md mb-6 w-full max-w-md h-auto" style="transition: transform 0.3s ease;">
        <div class="flex flex-col gap-4">
            <div class="flex justify-center gap-4">
                <button id="rotate-left-button" class="bg-blue-500 text-white py-3 px-6 rounded-full font-bold shadow-lg hover:bg-blue-600 transition-colors">üîÑ Girar para a Esquerda</button>
                <button id="rotate-right-button" class="bg-blue-500 text-white py-3 px-6 rounded-full font-bold shadow-lg hover:bg-blue-600 transition-colors">üîÑ Girar para a Direita</button>
            </div>
            <div class="flex justify-center gap-4 mt-6 w-full max-w-sm mx-auto">
                <button id="retake-photo-button" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-full font-bold shadow-lg hover:bg-gray-600 transition-colors">Tirar Outra</button>
                <button id="use-photo-button" class="flex-1 bg-teal-500 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-teal-600 transition-colors">Usar Foto</button>
            </div>
        </div>
    </div>

    <!-- Tela de Instru√ß√µes (Formato e Tamanho) -->
    <div id="shape-instruction-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-dashed border-blue-300 text-center transition-all duration-300 step-container">
        <!-- REMOVIDO: Bot√£o Voltar do Topo -->
        <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">An√°lise do Formato do P√© de <span id="shape-target-name" class="text-blue-600"></span></h2>
        <p class="text-gray-600 mb-6">Observe a imagem abaixo para entender onde as marca√ß√µes das pontas dos dedos devem ser feitas.</p>
        <img src="https://raw.githubusercontent.com/irmoneto/Analisador-Personalidade-Pelos-P-s/main/IMAGENS%20APP/EXEMPLO%20F%20P%C3%89S.PNG" alt="Exemplo de marca√ß√£o para formato do p√©" class="mx-auto rounded-lg shadow-md mb-8 w-full max-w-md h-auto border-2 border-gray-200">
        
        <!-- NOVO RODAP√â DE NAVEGA√á√ÉO -->
        <div class="flex justify-between items-center mt-8 pt-4 border-t border-gray-100">
            <button id="back-shape-instruction" class="flex items-center text-gray-600 font-semibold py-3 px-6 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Voltar
            </button>
            <button id="continue-to-shape-measurement" class="bg-blue-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-blue-700 cursor-pointer transition-transform duration-200 transform hover:scale-105">
              Continuar
            </button>
        </div>
    </div>
    <div id="ratio-instruction-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-dashed border-yellow-300 text-center transition-all duration-300 step-container">
        <!-- REMOVIDO: Bot√£o Voltar do Topo -->
        <h2 class="text-xl sm:text-2xl font-semibold mb-4 text-gray-800">An√°lise do Tamanho dos Dedos de <span id="ratio-target-name" class="text-blue-600"></span></h2>
        <p class="text-gray-600 mb-4">Voc√™ precisar√° fazer TR√äS marca√ß√µes na imagem do p√©:</p>
        <div class="text-left bg-yellow-50 p-4 rounded-lg mb-6 border-l-4 border-yellow-400">
          <ol class="list-decimal pl-5 space-y-3">
            <li><strong>Ponta do 2¬∫ dedo</strong></li>
            <li><strong>Base do 2¬∫ dedo</strong></li>
            <li><strong>Final do peito do p√©</strong></li>
          </ol>
        </div>
        <img src="https://raw.githubusercontent.com/irmoneto/Analisador-Personalidade-Pelos-P-s/main/IMAGENS%20APP/EXEMPLO%20T%20DEDOS.jpeg" alt="Exemplo de marca√ß√£o para tamanho dos dedos" class="mx-auto rounded-lg shadow-md mb-8 w-full max-w-md h-auto border-2 border-gray-200">
        
        <!-- NOVO RODAP√â DE NAVEGA√á√ÉO -->
        <div class="flex justify-between items-center mt-8 pt-4 border-t border-gray-100">
            <button id="back-ratio-instruction" class="flex items-center text-gray-600 font-semibold py-3 px-6 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Voltar
            </button>
            <button id="continue-to-ratio-measurement" class="bg-red-700 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-red-800 transition-transform duration-200 transform hover:scale-105">
              Entendi, Continuar
            </button>
        </div>
    </div>

    <!-- Medi√ß√£o (Comum para ambas as fases) -->
    <div id="measurement-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg transition-all duration-300 step-container">
      <!-- REMOVIDO: Bot√£o Voltar do Topo -->
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4">
        <h2 class="text-xl font-semibold text-gray-800 mb-2 sm:mb-0">Marque os Pontos para <span id="measurement-target-name" class="text-blue-600"></span></h2>
        <button id="redo-button" class="flex items-center gap-2 bg-gray-200 text-gray-700 py-2 px-4 rounded-full font-medium hover:bg-gray-300 transition-colors text-sm">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M21.5 2v6h-6"/><path d="M2.5 22v-6h6"/><path d="M4 20h5v-5M20 4h-5v5"/></svg>
            Refazer Marca√ß√µes
        </button>
      </div>
      <p id="instruction" class="bg-blue-100 border-l-4 border-blue-500 text-blue-800 p-4 mb-4 rounded-md font-medium"></p>
      <div class="relative bg-gray-50 rounded-lg overflow-hidden border-2 border-gray-300">
        <canvas id="imageCanvas" class="w-full h-auto custom-cursor"></canvas>
      </div>
      <div id="progress-container" class="mt-4 grid grid-cols-4 gap-2"></div>
      
      <!-- NOVO RODAP√â DE NAVEGA√á√ÉO -->
      <div class="flex justify-between items-center mt-6 pt-4 border-t border-gray-100">
          <button id="back-measurement" class="flex items-center text-gray-600 font-semibold py-3 px-6 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
              <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
              Voltar
          </button>
          <button id="calculate-button" class="bg-blue-500 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-blue-600 transition-colors hidden">
              Calcular
          </button>
      </div>
    </div>
    
    <!-- Resultado Formato -->
    <div id="shape-result-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-blue-300 transition-all duration-300 result-container">
        <!-- REMOVIDO: Bot√£o Voltar do Topo -->
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-center">Resultado do Formato do P√© de <span id="shape-result-target-name" class="text-blue-600"></span></h2>
      <div class="flex flex-col sm:flex-row gap-8">
          <!-- Conte√∫do do resultado de formato -->
        <div class="flex-1">
            <img id="shape-result-image" src="" alt="Foto do P√©" class="rounded-lg shadow-md mb-4 w-full h-auto">
        </div>
        <div class="flex-1 text-center">
            <div class="text-5xl font-extrabold mb-4" id="shape-emoji"></div>
            <div class="text-xl font-semibold mb-6" id="shape-text"></div>
            <p id="classification-reasoning" class="text-sm text-gray-600 mt-2"></p>
        </div>
      </div>
      <!-- NOVO RODAP√â DE NAVEGA√á√ÉO -->
      <div class="flex justify-between items-center mt-8 pt-4 border-t border-gray-200">
          <button id="back-shape-result" class="flex items-center text-gray-600 font-semibold py-3 px-6 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
              <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
              Voltar
          </button>
          <button id="analyze-ratio-button" class="bg-red-700 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-red-800 transition-colors transform hover:scale-105">
              Analisar Tamanho dos Dedos
          </button>
      </div>
    </div>

    <!-- Bloco de Resultado da An√°lise do Tamanho dos Dedos -->
    <div id="ratio-result-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-yellow-300 transition-all duration-300 result-container">
        <!-- REMOVIDO: Bot√£o Voltar do Topo -->
        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-center">Resultado da An√°lise do Tamanho dos Dedos de <span id="ratio-result-target-name" class="text-blue-600"></span></h2>
      <div class="flex flex-col sm:flex-row gap-8">
        <div class="flex-1">
          <img id="ratio-result-image" src="" alt="Foto do P√© com medi√ß√µes da An√°lise do Tamanho dos Dedos" class="rounded-lg shadow-md mb-4 w-full h-auto">
        </div>
        <div class="flex-1">
          <div class="text-center">
            <div id="ratio-result-ratio" class="text-5xl font-extrabold result-perfect mb-4"></div>
            <div id="ratio-result-text" class="text-xl font-semibold mb-6"></div>
          </div>
          <!-- Detalhes da raz√£o -->
          <div class="mt-8">
            <p class="text-center text-sm text-gray-500 mb-2">Proximidade com a Raz√£o Ideal</p>
            <div class="relative w-full max-w-sm mx-auto h-3 bg-gray-200 rounded-full">
                <div id="ratio-progress-bar" class="absolute h-3 rounded-full transition-all duration-500"></div>
            </div>
          </div>
        </div>
      </div>
      <!-- NOVO RODAP√â DE NAVEGA√á√ÉO -->
      <div class="flex justify-between items-center mt-8 pt-4 border-t border-gray-200">
          <button id="back-ratio-result" class="flex items-center text-gray-600 font-semibold py-3 px-6 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
              <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
              Voltar
          </button>
          <button id="new-ratio-analysis-button" class="bg-red-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-red-700 transition-colors transform hover:scale-105">
              An√°lise das Unhas
          </button>
      </div>
    </div>
    
    <!-- Pergunta sobre Unhas (Adapta√ß√£o para Pessoa 1 ou 2) -->
    <div id="nails-question-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-orange-300 transition-all duration-300 step-container">
        <!-- REMOVIDO: Bot√£o Voltar do Topo -->
        <h2 class="text-2xl sm:text-3xl font-extrabold text-gray-800 mb-6 text-center">An√°lise das Unhas dos P√©s de <span id="nails-target-name" class="text-blue-600"></span></h2>
        
        <div class="flex flex-col sm:flex-row gap-8 items-center mb-8">
            <div class="flex-1">
                <img id="nails-result-image" src="" alt="Foto do P√© para an√°lise de unhas" class="rounded-lg shadow-xl w-full h-auto border-4 border-gray-200">
            </div>
            <div class="flex-1">
                <img src="https://raw.githubusercontent.com/irmoneto/Analisador-Personalidade-Pelos-P-s/main/IMAGENS%20APP/TAMANHO%20UNHAS.png" alt="Exemplo de tamanho de unhas" class="rounded-lg shadow-xl w-full h-auto border-4 border-gray-200">
            </div>
        </div>

        <div class="text-center">
            <p class="text-xl font-semibold mb-4">A maioria das suas unhas dos p√©s s√£o:</p>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
                <label class="flex flex-col items-center p-4 rounded-lg bg-gray-50 border border-gray-200 cursor-pointer hover:bg-gray-100">
                    <input type="radio" name="nails-visibility" value="Pouco Vis√≠veis" class="mb-2">
                    <span class="font-medium">POUCO VIS√çVEIS</span>
                </label>
                <label class="flex flex-col items-center p-4 rounded-lg bg-gray-50 border border-gray-200 cursor-pointer hover:bg-gray-100">
                    <input type="radio" name="nails-visibility" value="Normais" class="mb-2">
                    <span class="font-medium">VIS√çVEIS (NORMAIS)</span>
                </label>
                <label class="flex flex-col items-center p-4 rounded-lg bg-gray-50 border border-gray-200 cursor-pointer hover:bg-gray-100">
                    <input type="radio" name="nails-visibility" value="Bem Vis√≠veis" class="mb-2">
                    <span class="font-medium">BEM VIS√çVEIS</span>
                </label>
            </div>
            
            <p id="nails-error" class="text-red-500 text-sm mt-4 hidden">Por favor, selecione uma op√ß√£o para prosseguir.</p>
        </div>
        
        <!-- NOVO RODAP√â DE NAVEGA√á√ÉO -->
        <div class="flex justify-between items-center mt-8 pt-4 border-t border-gray-200">
            <button id="back-nails-question" class="flex items-center text-gray-600 font-semibold py-3 px-6 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Voltar
            </button>
            <button id="continue-to-next-step" class="bg-purple-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-purple-700 transition-colors inline-flex items-center justify-center">
                <span id="button-text-next">
                    Prosseguir para a An√°lise da Pessoa 2
                </span>
                <span id="button-text-generate" class="hidden">
                    Gerar Relat√≥rio de Compatibilidade
                </span>
                <span id="loading-spinner" class="hidden loading-spinner ml-2"></span>
            </button>
        </div>
    </div>
    
    <!-- Relat√≥rio Completo de An√°lise (AGORA RELAT√ìRIO DE COMPATIBILIDADE) -->
    <div id="comparison-report-block" class="bg-white p-8 sm:p-12 rounded-xl shadow-lg border-2 border-green-300 transition-all duration-300 step-container">
        
        <!-- T√≠tulo -->
        <div class="text-center mb-10 pb-6 border-b border-gray-200 pdf-page-break-after">
            <!-- NOVO T√çTULO EM DUAS LINHAS -->
            <h2 class="text-2xl sm:text-3xl font-bold text-teal-700 mb-1">RELAT√ìRIO DE AN√ÅLISE DE "MATCH"</h2>
            <h2 class="text-2xl sm:text-3xl font-bold text-teal-700 mb-3">PELOS P√âS - By @IrmoNeto</h2>
            
            <!-- CORRIGIDO: Distribui√ß√£o do nome em duas linhas -->
            <p class="text-xl text-gray-700">Compatibilidade dos P√©s de</p>
            <p class="text-2xl font-bold text-teal-600 mt-1">
                <span id="report-target-name-p1" class="font-bold"></span> & <span id="report-target-name-p2" class="font-bold"></span>
            </p>
        </div>

        <!-- An√°lises Individuais (Resumo) -->
        <div class="flex flex-col space-y-8">
            <h3 class="text-2xl font-extrabold text-gray-800 text-center">AN√ÅLISE INDIVIDUAL SIMPLIFICADA</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                <!-- Resumo Pessoa 1 (CORRIGIDO: Cores para verde) -->
                <div class="bg-green-50 p-6 rounded-lg border border-green-200">
                    <!-- T√≠tulo alterado para verde escuro (text-green-800) -->
                    <h4 class="text-xl font-bold text-green-800 mb-4 border-b pb-2" id="report-p1-title"></h4>
                    <ul class="space-y-3 text-gray-700 mt-4 text-sm">
                        <li class="flex justify-between"><strong>Formato:</strong> <span id="summary-p1-shape" class="font-semibold text-right"></span></li>
                        <li class="flex justify-between"><strong>Tamanho Dedos:</strong> <span id="summary-p1-ratio" class="font-semibold text-right"></span></li>
                        <li class="flex justify-between"><strong>Tamanho Unhas:</strong> <span id="summary-p1-nails" class="font-semibold text-right"></span></li> 
                    </ul>
                    <!-- CORRIGIDO: Imagem injetada via JS, fallback removido -->
                    <img id="final-report-image-p1" src="" alt="Foto do P√© 1" class="mx-auto rounded-lg shadow-md mt-4 border border-gray-300" style="max-width: 150px;">
                </div>
                <!-- Resumo Pessoa 2 (CORRIGIDO: Cores para verde) -->
                <div class="bg-green-50 p-6 rounded-lg border border-green-200">
                    <!-- T√≠tulo alterado para verde escuro (text-green-800) -->
                    <h4 class="text-xl font-bold text-green-800 mb-4 border-b pb-2" id="report-p2-title"></h4>
                    <ul class="space-y-3 text-gray-700 mt-4 text-sm">
                        <li class="flex justify-between"><strong>Formato:</strong> <span id="summary-p2-shape" class="font-semibold text-right"></span></li>
                        <li class="flex justify-between"><strong>Tamanho Dedos:</strong> <span id="summary-p2-ratio" class="font-semibold text-right"></span></li>
                        <li class="flex justify-between"><strong>Tamanho Unhas:</strong> <span id="summary-p2-nails" class="font-semibold text-right"></span></li> 
                    </ul>
                    <!-- CORRIGIDO: Imagem injetada via JS, fallback removido -->
                    <img id="final-report-image-p2" src="" alt="Foto do P√© 2" class="mx-auto rounded-lg shadow-md mt-4 border border-gray-300" style="max-width: 150px;">
                </div>
            </div>
        </div>

        <div class="mt-10 pt-4 border-t border-gray-200 pdf-page-break-after">
            <h3 class="text-2xl font-extrabold text-green-700 mb-6 text-center">AN√ÅLISE DE COMPATIBILIDADE INTERPESSOAL</h3>
            
            <div id="comparison-analysis-result" class="prose max-w-none text-gray-800 leading-relaxed bg-gray-50 p-6 sm:p-8 rounded-lg border-l-4 border-green-400">
                Aguardando dados para gerar o relat√≥rio comparativo...
            </div>
        </div>
        
        <!-- CTA para P√°gina de Vendas -->
        <div class="mt-8 mb-4 text-center">
            <h4 class="text-xl font-bold text-gray-800 mb-4">Quer saber mais sobre o seu p√© e como ele revela sua personalidade?</h4>
            <a href="https://irmoneto.github.io/INFOPRODUTOS-BY-IRMONETO/" target="_blank" class="inline-flex items-center justify-center bg-yellow-500 text-white py-3 px-8 rounded-full font-bold shadow-xl hover:bg-yellow-600 transition-colors transform hover:scale-[1.03] text-lg w-full sm:w-auto">
                CLIQUE AQUI E ACESSE MAIS CONTE√öDOS SOBRE O TEMA
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path></svg>
            </a>
        </div>
    
        <!-- Bot√µes de A√ß√£o Final (Com bot√£o Compartilhar Adicionado) -->
        <div class="mt-10 flex flex-col sm:flex-row justify-center items-center gap-4 action-buttons">
            <button id="save-analysis-button" class="bg-green-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-green-700 transition-colors w-full sm:w-auto">
                Salvar Relat√≥rio em PDF
            </button>
             <!-- NOVO: Bot√£o Compartilhar Resultado -->
            <button id="share-analysis-button" class="bg-teal-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-teal-700 transition-colors w-full sm:w-auto">
                Compartilhar Resultado
            </button>
            <!-- NOVO: Bot√£o de voltar para a √∫ltima etapa -->
            <button id="back-from-report-button" class="bg-gray-500 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-gray-600 transition-colors w-full sm:w-auto">
                Voltar √† An√°lise da Pessoa 2
            </button>
            <button id="start-new-full-analysis-button" class="bg-blue-600 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-blue-700 transition-colors w-full sm:w-auto">
                Realizar Nova An√°lise
            </button>
        </div>
    </div>

    <!-- Bloco para Documentos Legais (mantido) -->
    <div id="legal-documents-block" class="bg-white p-6 sm:p-8 rounded-xl shadow-lg border-2 border-red-300 transition-all duration-300 step-container max-w-3xl mx-auto">
        <!-- Conte√∫do legal... (omitido para brevidade, mas o JS o manter√°) -->
        <div class="text-center mb-6">
            <h2 class="text-2xl sm:text-3xl font-bold text-red-700 mb-2">Termos Legais do Aplicativo</h2>
            <p class="text-gray-600">√öltima atualiza√ß√£o: Outubro de 2025</p>
        </div>

        <div class="space-y-8 text-gray-700 text-sm">
            <!-- TERMOS DE USO -->
            <div id="terms-of-use" class="border-b pb-4">
                <h3 class="text-xl font-bold text-gray-800 mb-3">1. TERMOS DE USO</h3>
                <p class="font-semibold mb-2">1.1. Direitos Autorais e Propriedade Intelectual</p>
                <p class="ml-4 mb-2">Todo o c√≥digo, design, metodologia de an√°lise e conte√∫do textual (incluindo o Relat√≥rio Final) s√£o de propriedade exclusiva do desenvolvedor, **Irmo Zuccato Neto**. A propriedade intelectual √© protegida por leis de direitos autorais.</p>
                
                <p class="font-semibold mb-2">1.2. Limita√ß√µes de Uso e Proibi√ß√µes</p>
                <ul class="list-disc list-inside ml-4 space-y-1">
                    <li>O uso do aplicativo destina-se exclusivamente √† an√°lise pessoal ou de cliente, conforme as funcionalidades oferecidas.</li>
                    <li>√â estritamente **proibida** a reprodu√ß√£o, c√≥pia, modifica√ß√£o, engenharia reversa, distribui√ß√£o ou revenda do c√≥digo ou da metodologia subjacente.</li>
                    <li>A reprodu√ß√£o total ou parcial do Relat√≥rio Final para fins comerciais (venda, publica√ß√£o em massa) sem autoriza√ß√£o expressa do desenvolvedor √© proibida.</li>
                </ul>
            </div>
            
            <!-- POL√çTICA DE PRIVACIDADE -->
            <div id="privacy-policy" class="border-b pb-4">
                <h3 class="text-xl font-bold text-gray-800 mb-3">2. POL√çTICA DE PRIVACIDADE</h3>
                <p class="font-semibold mb-2">2.1. Coleta e Uso de Dados</p>
                <p class="ml-4 mb-2">Coletamos apenas o **nome** do usu√°rio e/ou cliente para fins de personaliza√ß√£o do relat√≥rio. Estes nomes s√£o exibidos no Relat√≥rio Final gerado, mas n√£o s√£o armazenados em um banco de dados persistente neste momento.</p>
                
                <p class="font-semibold mb-2">2.2. Armazenamento e Uso de Imagens</p>
                <p class="ml-4 mb-2">A **imagem do p√©** √© usada unicamente para a realiza√ß√£o das medi√ß√µes visuais no dispositivo do usu√°rio (navegador) e para inclus√£o no Relat√≥rio Final (PDF/Visualiza√ß√£o). A imagem **n√£o √© enviada, armazenada ou compartilhada** com o desenvolvedor ou terceiros, sendo descartada ap√≥s o encerramento da sess√£o ou in√≠cio de nova an√°lise.</p>
                
                <p class="font-semibold mb-2">2.3. Cookies e Rastreamento (Tracking)</p>
                <p class="ml-4">O aplicativo **n√£o utiliza cookies** de rastreamento de terceiros (tracking) ou ferramentas de analytics que coletam dados pessoais. O uso do Tailwind CSS e HTML2PDF √© baseado em CDNs de terceiros, mas sem coleta de dados espec√≠fica do usu√°rio por este aplicativo.</p>
            </div>

            <!-- LICEN√áA DE SOFTWARE -->
            <div id="software-license" class="border-b pb-4">
                <h3 class="text-xl font-bold text-gray-800 mb-3">3. LICEN√áA DE USO (USU√ÅRIO FINAL)</h3>
                <p class="font-semibold mb-2">3.1. Permiss√µes Concedidas</p>
                <p class="ml-4 mb-2">√â concedida ao usu√°rio uma licen√ßa limitada, n√£o exclusiva e intransfer√≠vel para usar este software para fins pessoais ou profissionais de an√°lise (clientes), conforme a proposta original.</p>
                
                <p class="font-semibold mb-2">3.2. Restri√ß√µes e Penalidades</p>
                <p class="ml-4">A viola√ß√£o das limita√ß√µes de uso e das proibi√ß√µes de reprodu√ß√£o (item 1) pode resultar em penalidades legais, incluindo, mas n√£o se limitando a, a√ß√µes por viola√ß√£o de direitos autorais e danos morais, conforme a legisla√ß√£o brasileira e internacional aplic√°vel.</p>
            </div>

            <!-- AVISOS LEGAIS -->
            <div id="legal-disclaimers">
                <h3 class="text-xl font-bold text-gray-800 mb-3">4. AVISOS LEGAIS E LIMITA√á√ÉO DE RESPONSABILIDADE</h3>
                <p class="font-semibold mb-2">4.1. Disclaimer M√©dico</p>
                <p class="ml-4 mb-2 bg-yellow-100 p-2 rounded">**O Aplicativo n√£o oferece diagn√≥stico m√©dico, psicol√≥gico, quiropr√°tico ou podol√≥gico.** A an√°lise √© baseada em estudos de leitura de p√©s com finalidade de autoconhecimento e desenvolvimento personal. Use o Relat√≥rio Final apenas como uma ferramenta complementar e n√£o substitua a avalia√ß√£o de um profissional de sa√∫de qualificado.</p>
                
                <p class="font-semibold mb-2">4.2. Limita√ß√£o de Responsabilidade</p>
                <p class="ml-4 mb-2">O desenvolvedor n√£o se responsabiliza por quaisquer danos diretos ou indiretos decorrentes do uso (ou mau uso) da an√°lise e das informa√ß√µes geradas por este aplicativo.</p>
                
                <p class="font-semibold mb-2">4.3. Jurisdi√ß√£o Aplic√°vel</p>
                <p class="ml-4">Estes Termos e o uso do aplicativo s√£o regidos pelas leis da Rep√∫blica Federativa do Brasil.</p>
            </div>
        </div>
        
        <div class="mt-8 text-center">
            <button id="back-from-legal-button" class="bg-red-500 text-white py-3 px-8 rounded-full font-bold shadow-lg hover:bg-red-600 transition-colors">
                Voltar ao Aplicativo
            </button>
        </div>
    </div>
  </div>

  <div id="copy-notification">Relat√≥rio copiado para a √°rea de transfer√™ncia!</div>
    
  <!-- REMOVIDO: Barra de Navega√ß√£o Flutuante para Mobile, pois a navega√ß√£o agora √© interna nos blocos. -->


  <script>
    
    // --- DADOS RELACIONAIS EMBUTIDOS (Extra√≠dos do relacionamentos_interpessoais.sql) ---
    // Estrutura: [Tipo] -> [Combina√ß√£o P1 X P2] -> { fortes: '...', fracos: '...', analise_curta: '...' }
    const RELATIONAL_DATA = {
        "Formato": {
            "Eg√≠pcio X Eg√≠pcio": { fortes: 'Duas mentes lineares se unem, criando uma parceria extremamente focada, pr√°tica e eficiente. H√° clareza m√∫tua de objetivos e alta capacidade de execu√ß√£o. A previsibilidade gera seguran√ßa e baixa ambiguidade.', fracos: 'A rigidez pode ser dupla, levando a conflitos de controle e dificuldade em ceder. Falta de abertura para o improviso ou a intui√ß√£o. Tend√™ncia a ignorar nuances emocionais em favor da tarefa.', analise_curta: 'Aqui temos um encontro de mentes estrat√©gicas. Ambos gostam de planejar, entender e analisar tudo antes de agir, por isso √© mais f√°cil o papo fluir, as ideias se encaixam... mas quanto a agir, isso √© diferente. Match mental forte, mas cuidado com o excesso de ‚Äúvamos pensar sobre isso‚Äù.' },
            "Eg√≠pcio X Grego/Romano": { fortes: 'O linear (Eg√≠pcio) complementa o sist√™mico (Grego/Romano). O Eg√≠pcio traz o foco na execu√ß√£o e o G/R a vis√£o estrat√©gica e de longo prazo. Excelente para projetos, combinando planejamento detalhado com a√ß√£o objetiva.', fracos: 'O Eg√≠pcio pode ver o G/R como excessivamente te√≥rico ou lento. O G/R pode ver o Eg√≠pcio como apressado e simplista, ignorando a complexidade. Conflito entre a necessidade de agir logo e a necessidade de analisar tudo.', analise_curta: 'O Eg√≠pcio traz o foco na execu√ß√£o e o Grego/Romano a vis√£o de longo prazo. Match pr√°tico e estrat√©gico, onde um ensina o outro a aterrar sonhos e a sonhar com mais profundidade. Cuidado com o atrito entre a pressa e a an√°lise excessiva.' },
            "Eg√≠pcio X Quadrado": { fortes: 'O Quadrado traz a vis√£o ut√≥pica e integradora, e o Eg√≠pcio traz a praticidade e o passo a passo (o "como"). O Eg√≠pcio ajuda a concretizar o ideal do Quadrado, focando a energia dispersa.', fracos: 'O Eg√≠pcio se frustra com a dispers√£o e o idealismo do Quadrado. O Quadrado se sente limitado ou podado pela rigidez e objetividade excessiva do Eg√≠pcio. Comunica√ß√£o pode falhar entre o "sonho" e a "realidade".', analise_curta: 'Aqui a vis√£o ut√≥pica (Quadrado) encontra a execu√ß√£o objetiva (Eg√≠pcio). O Eg√≠pcio d√° estrutura ao idealismo do Quadrado, mas precisa ter paci√™ncia com a dispers√£o. Match com potencial de concretiza√ß√£o de grandes ideias, se houver toler√¢ncia √† diferen√ßa de ritmo mental.' },
            "Grego/Romano X Grego/Romano": { fortes: 'Parceria baseada na vis√£o de mundo e na estrat√©gia. Entendimento m√∫tuo da necessidade de an√°lise, detalhismo e planejamento. Criam sistemas complexos e bem estruturados juntos.', fracos: 'Risco de paralisia por an√°lise. Demoram muito para iniciar a a√ß√£o. Podem se perder em detalhes e teorias, dificultando a simplicidade e a execu√ß√£o pr√°tica.', analise_curta: 'Aqui temos um encontro de mentes estrat√©gicas. Ambos gostam de planejar, entender e analisar tudo antes de agir, por isso √© mais f√°cil o papo fluir, as ideias se encaixam... mas quanto a agir, isso √© diferente. Match mental forte, mas cuidado com o excesso de ‚Äúvamos pensar sobre isso‚Äù.' },
            "Grego/Romano X Quadrado": { fortes: 'Compartilham a vis√£o ampla e a avers√£o √† simplicidade. O G/R estrutura a utopia do Quadrado em esquemas e planos vi√°veis. Grande potencial para inova√ß√£o e solu√ß√µes hol√≠sticas.', fracos: 'Ambos podem ser abstratos demais, com pouca conex√£o com a terra e a pr√°tica. O G/R pode tentar enquadrar o idealismo do Quadrado, gerando atrito. Risco de dispers√£o intelectual.', analise_curta: 'Ambos valorizam a vis√£o ampla e a complexidade, criando um ambiente de alta inova√ß√£o e estrat√©gia. O desafio √© sair do campo das ideias: o Grego/Romano deve liderar o planejamento para transformar a utopia do Quadrado em algo execut√°vel. Risco de viverem "na lua".' },
            "Quadrado X Quadrado": { fortes: 'Rela√ß√£o de grande liberdade mental, aceita√ß√£o de complexidade e forte idealismo. Apoio m√∫tuo na busca por solu√ß√µes integrais e √©ticas. Criam um ambiente de n√£o julgamento e vasta abertura de ideias.', fracos: 'Extrema dispers√£o, falta de foco e objetividade. O idealismo pode levar √† frustra√ß√£o com o mundo real. Dificuldade em tomar decis√µes pr√°ticas e concluir projetos.', analise_curta: 'Dupla de mentes livres e integradoras. Excelente para debater grandes conceitos e ideais, mas p√©ssima para decis√µes do dia a dia. √â um match de "mentes brilhantes" que precisam de algu√©m de fora para fazer a lista do supermercado. O desafio √© aterrar as ideias ut√≥picas.' }
        },
        "Tamanho Dedos": {
            "Curtos X Curtos": { fortes: 'Dupla pr√°tica, objetiva e voltada √† a√ß√£o. Alta capacidade de execu√ß√£o e de resolver problemas de forma direta. Rela√ß√£o com pouca hesita√ß√£o e foco em resultados imediatos.', fracos: 'Impaci√™ncia m√∫tua e baixa toler√¢ncia √† reflex√£o ou ao emocional. Podem ser r√≠gidos e ter dificuldade em aceitar que o outro desacelere. Conflitos tendem a ser diretos e r√°pidos, mas pouco elaborados.', analise_curta: 'Ambos s√£o fogo e movimento. Match de a√ß√£o imediata e efici√™ncia, mas com impaci√™ncia dobrada. Se um precisar de tempo para refletir, o outro estar√° na porta esperando. O desafio √© aprender a respirar junto e dar espa√ßo √† emo√ß√£o.' },
            "Curtos X Normais": { fortes: 'O Curto traz a a√ß√£o e o resultado, o Normal traz o equil√≠brio e a pondera√ß√£o. O Normal modera o impulso do Curto e o Curto estimula a a√ß√£o do Normal. Parceria est√°vel e com boa sinergia entre pr√°tica e consci√™ncia.', fracos: 'O Curto pode considerar o Normal lento ou excessivamente emocional. O Normal pode se sentir pressionado ou desrespeitado pelo imediatismo do Curto. Conflito entre a velocidade e a necessidade de processar.', analise_curta: 'Um √© fogo e movimento, o outro √© equil√≠brio e bom senso. Quando juntos, se completam, pois um acelera, o outro ajusta o ritmo. Mas se n√£o houver sintonia, pode rolar atrito entre impulsividade e paci√™ncia. Match energ√©tico equilibrado, com potencial real de crescimento.' },
            "Curtos X Longos": { fortes: 'O Longo traz a vis√£o, a criatividade e a profundidade, e o Curto traz a concretiza√ß√£o e a disciplina. O Curto aterra as ideias do Longo, e o Longo inspira a mente do Curto. Potencial para grandes realiza√ß√µes.', fracos: 'O Longo tende a ver o Curto como simpl√≥rio ou insens√≠vel. O Curto se frustra com a abstra√ß√£o e a dispers√£o do Longo. Rela√ß√£o exige toler√¢ncia para a diferen√ßa de ritmo (r√°pido vs. reflexivo).', analise_curta: 'O Curto √© p√© no ch√£o, o Longo √© cabe√ßa nas nuvens. O Curto oferece a √¢ncora para as ideias criativas do Longo. O desafio √© gigantesco: o Longo precisa descer e o Curto precisa subir, ou o atrito da diferen√ßa de ritmo pode levar √† frustra√ß√£o m√∫tua. Grande potencial de aprendizado.' },
            "Normais X Normais": { fortes: 'Rela√ß√£o de harmonia, estabilidade e previsibilidade. Grande equil√≠brio emocional e facilidade em encontrar o meio-termo. Ambas as partes valorizam a coer√™ncia e a sensibilidade.', fracos: 'Risco de acomoda√ß√£o, falta de impulso para grandes mudan√ßas ou ousadia. Podem ser excessivamente cautelosos e evitar conflitos necess√°rios, resultando em insatisfa√ß√£o velada.', analise_curta: 'Dupla de equil√≠brio. Trazem estabilidade, coer√™ncia e previsibilidade para a rela√ß√£o. O ponto fraco √© o excesso de cautela: evitam o confronto e podem cair na acomoda√ß√£o, faltando o impulso para grandes saltos ou mudan√ßas. Match seguro, mas que precisa de um "empurr√£ozinho" para crescer.' },
            "Normais X Longos": { fortes: 'O Longo traz a sensibilidade e a reflex√£o aprofundada, e o Normal, o enraizamento e a estabilidade. O Normal ajuda a estabilizar as emo√ß√µes do Longo e o Longo aprofunda a percep√ß√£o do Normal.', fracos: 'O Longo pode sentir falta de profundidade no Normal. O Normal pode se sentir sobrecarregado pela hipersensibilidade ou pela dispers√£o mental do Longo.', analise_curta: 'O Longo traz profundidade e intui√ß√£o; o Normal, estabilidade e senso pr√°tico. Match que funciona se o Normal n√£o for muito racional: o Normal oferece um ch√£o seguro para o Longo sonhar. O desafio √© a hipersensibilidade do Longo, que pode sobrecarregar o equil√≠brio do Normal.' },
            "Longos X Longos": { fortes: 'Rela√ß√£o de grande profundidade, criatividade e riqueza emocional. Ambas as partes valorizam a an√°lise, a escuta e a abstra√ß√£o. Forte conex√£o no campo das ideias e da intui√ß√£o.', fracos: 'Pouca conex√£o com a realidade pr√°tica e dificuldade em tomar decis√µes r√°pidas. Risco de dispers√£o e de se perder em reflex√µes excessivas. Podem ser hipersens√≠veis e facilmente sobrecarregados pela emo√ß√£o.', analise_curta: 'Dupla de sonhadores, poetas e analistas. Grande conex√£o na imagina√ß√£o e no campo emocional profundo. O problema √© o mundo real: ambos podem se perder em an√°lises e reflex√µes sem nunca tomar uma atitude. Match de alma, mas que precisa de um despertador e um calend√°rio.' }
        },
        "Tamanho das Unhas": {
            "Pouco Vis√≠veis X Pouco Vis√≠veis": { fortes: 'Dupla com alta flexibilidade e adaptabilidade. F√°cil aceita√ß√£o das ideias e mudan√ßas um do outro. Cria um ambiente de n√£o-julgamento e abertura.', fracos: 'Vulnerabilidade m√∫tua √† opini√£o externa e dificuldade em sustentar convic√ß√µes firmes. Risco de indecis√£o e de serem influenciados por terceiros no relacionamento.', analise_curta: 'Ambos s√£o flex√≠veis e abertos a novas verdades. Match f√°cil, com alta capacidade de adapta√ß√£o. Mas o ponto fraco √© a indecis√£o, pois nenhum dos dois ter√° firmeza total para tomar a dianteira e sustentar uma convic√ß√£o contra a mar√©. Cuidado com a influ√™ncia de terceiros.' },
            "Pouco Vis√≠veis X Normais": { fortes: 'O Normal traz estabilidade e assertividade ao flex√≠vel Pouco Vis√≠vel. O Pouco Vis√≠vel oferece maleabilidade para que o Normal n√£o se torne r√≠gido. Boa rela√ß√£o entre adapta√ß√£o e consist√™ncia.', fracos: 'O Pouco Vis√≠vel pode sentir que o Normal √© r√≠gido ou impositivo. O Normal pode ver o Pouco Vis√≠vel como inconstante ou com pouca convic√ß√£o. O Normal precisa cuidar para n√£o anular a voz do Pouco Vis√≠vel.', analise_curta: 'Um traz firmeza e convic√ß√£o, o outro di√°logo e flexibilidade. Essa mistura cria seguran√ßa emocional e espa√ßo para a verdade de ambos. Mas o Normal precisa ter tato para n√£o anular a voz do Pouco Vis√≠vel, que pode ceder demais para manter a paz. Match de confian√ßa.' },
            "Pouco Vis√≠veis X Bem Vis√≠veis": { fortes: 'O Bem Vis√≠vel traz firmeza, dire√ß√£o e seguran√ßa para o Pouco Vis√≠vel. O Pouco Vis√≠vel oferece flexibilidade e escuta que o Bem Vis√≠vel precisa para n√£o se fechar. Potencial para grande aprendizado m√∫tuo.', fracos: 'Conflito de poder: o Bem Vis√≠vel pode ser dogm√°tico e tentar impor suas verdades. O Pouco Vis√≠vel pode se sentir anulado ou ter suas cren√ßas invalidadas, levando a um desequil√≠brio de influ√™ncia no relacionamento.', analise_curta: 'O Bem Vis√≠vel √© a rocha, o Pouco Vis√≠vel √© a √°gua. Forte desequil√≠brio de poder e influ√™ncia. O Bem Vis√≠vel precisa aprender a ouvir e o Pouco Vis√≠vel precisa aprender a dizer "n√£o". O match √© de for√ßa e vulnerabilidade, com grande potencial de crescimento, mas risco de atrito constante.' },
            "Normais X Normais": { fortes: 'Dupla com estabilidade. Rela√ß√£o equilibrada, previs√≠vel e com assertividade saud√°vel. Ambas as partes conseguem ouvir e se posicionar com modera√ß√£o. Forte senso de coopera√ß√£o.', fracos: 'Tend√™ncia √† zona de conforto e a evitar conflitos ou grandes debates. Risco de a rela√ß√£o se tornar mon√≥tona ou de cederem em excesso para manter a paz, sem abordar quest√µes profundas.', analise_curta: 'Match de diplomacia e modera√ß√£o. Ambos buscam o equil√≠brio e a paz. Rela√ß√£o segura, mas com risco de evitar conflitos importantes em nome da harmonia. Precisam cultivar a coragem de discordar para a rela√ß√£o n√£o estagnar na zona de conforto.' },
            "Normais X Bem Vis√≠veis": { fortes: 'O Bem Vis√≠vel oferece firmeza e seguran√ßa nas decis√µes. O Normal traz equil√≠brio e tato para modular a rigidez do Bem Vis√≠vel. O Normal atua como um mediador que facilita a comunica√ß√£o das verdades do Bem Vis√≠vel.', fracos: 'O Bem Vis√≠vel pode se frustrar com a modera√ß√£o do Normal, querendo mais determina√ß√£o. O Normal pode se sentir pressionado pela autoridade de convic√ß√£o do Bem Vis√≠vel. O Normal precisa garantir que sua voz n√£o seja ofuscada.', analise_curta: 'Um traz firmeza e convic√ß√£o, o outro di√°logo e flexibilidade. Essa mistura cria seguran√ßa emocional e espa√ßo para a verdade de ambos. Mas o Normal precisa ter tato para n√£o anular a voz do Pouco Vis√≠vel, que pode ceder demais para manter a paz. Match de confian√ßa.' },
            "Bem Vis√≠veis X Bem Vis√≠veis": { fortes: 'Rela√ß√£o de grande determina√ß√£o, seguran√ßa e for√ßa de prop√≥sito. Ambas as partes s√£o firmes em seus valores, criando uma base inabal√°vel e confi√°vel. Alta capacidade de lideran√ßa conjunta.', fracos: 'Conflito de dogmas e rigidez. Dificuldade extrema em ceder ou pedir desculpas. Rela√ß√£o pode ser marcada por debates intensos e falta de flexibilidade em aceitar a vis√£o do outro, gerando exaust√£o.', analise_curta: 'Dupla de rochas e dogmas. A convic√ß√£o √© o forte, a rigidez √© o ponto fraco. Match com potencial de for√ßa inabal√°vel, mas alto risco de confronto por querer ter a √∫ltima palavra. Ambos precisam aprender que ceder n√£o √© perder, e que a verdade pode ter v√°rias faces.' }
        }
    };
    
    // Mapeamento dos resultados de Tamanho de Dedos (Ratio) para as categorias de relacionamento (Curtos/Normais/Longos)
    const RATIO_MAP = {
        'Dedos Curtos': 'Curtos',
        'Normais para Curtos': 'Normais',
        'Normais (An√°lise do Tamanho dos Dedos)': 'Normais',
        'Normais para Longos': 'Normais',
        'Dedos Longos': 'Longos'
    };
    
    // NOVO: Fun√ß√£o para garantir ordena√ß√£o consistente das chaves de relacionamento
    function sortRelationalKey(val1, val2) {
        // Define uma ordem de prioridade para garantir que a chave generada seja √∫nica (ex: 'A X B' ou 'B X A', mas nunca ambas)
        const order = ['Eg√≠pcio', 'Grego/Romano', 'Quadrado', 'Curtos', 'Normais', 'Longos', 'Pouco Vis√≠veis', 'Bem Vis√≠veis'];
        
        // Se as chaves s√£o as mesmas, retorna a chave √∫nica
        if (val1 === val2) {
            return `${val1} X ${val2}`;
        }

        // Se uma das chaves estiver na lista de ordem e for anterior, usa essa ordem
        const index1 = order.indexOf(val1);
        const index2 = order.indexOf(val2);

        if (index1 !== -1 && index2 !== -1) {
            return index1 < index2 ? `${val1} X ${val2}` : `${val2} X ${val1}`;
        }
        
        // Se a ordena√ß√£o personalizada falhar, usa a ordena√ß√£o alfab√©tica padr√£o (como fallback)
        return [val1, val2].sort().join(' X ');
    }
    
    // Fun√ß√£o para criar o cont√™iner do an√∫ncio (Mantida)
    function createAdContainer() {
        const ins = document.createElement('ins');
        ins.className = 'adsbygoogle';
        ins.style.display = 'block';
        ins.setAttribute('data-ad-client', 'ca-pub-2957847231347233'); 
        ins.setAttribute('data-ad-format', 'auto');
        ins.setAttribute('data-full-width-responsive', 'true');
        
        (window.adsbygoogle = window.adsbygoogle || []).push({});

        const container = document.createElement('div');
        container.className = 'my-4 w-full text-center';
        container.appendChild(ins);
        
        return container;
    }
    
    // Fun√ß√£o para renderizar o an√∫ncio em um ID de cont√™iner espec√≠fico
    function renderAd(containerId) {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = '';
            container.appendChild(createAdContainer());
        }
    }
    // ----------------------------------------------------------------
    
    document.addEventListener('DOMContentLoaded', () => {
      // --- ELEMENTOS HTML ---
      const appMainContent = document.getElementById('app-main-content');
      const splashScreen = document.getElementById('splash-screen');
      const personalizationBlock = document.getElementById('personalization-block');
      const uploadBlock = document.getElementById('upload-block');
      const measurementBlock = document.getElementById('measurement-block');
      const shapeInstructionBlock = document.getElementById('shape-instruction-block');
      const ratioInstructionBlock = document.getElementById('ratio-instruction-block');
      const shapeResultBlock = document.getElementById('shape-result-block');
      const ratioResultBlock = document.getElementById('ratio-result-block');
      const nailsQuestionBlock = document.getElementById('nails-question-block');
      const comparisonReportBlock = document.getElementById('comparison-report-block');
      const appHeaderContainer = document.getElementById('app-header-container');
      const previewBlock = document.getElementById('preview-block');
      const legalDocumentsBlock = document.getElementById('legal-documents-block');
      
      // REMOVIDO: Refer√™ncias √† barra de navega√ß√£o inferior

      // --- BOT√ïES E FLUXO ---
      const startButton = document.getElementById('start-button');
      const continueToUploadButton = document.getElementById('continue-to-upload');
      const analyzeRatioButton = document.getElementById('analyze-ratio-button');
      const newRatioAnalysisButton = document.getElementById('new-ratio-analysis-button');
      // Bot√£o renomeado para gerenciar a transi√ß√£o P1->P2->Relat√≥rio
      const continueToNextStep = document.getElementById('continue-to-next-step'); 
      const startNewFullAnalysisButton = document.getElementById('start-new-full-analysis-button');
      const imageUpload = document.getElementById('image-upload');
      const redoButton = document.getElementById('redo-button');
      const calculateButton = document.getElementById('calculate-button');
      const nativeCameraInput = document.getElementById('native-camera-input');
      
      const nailsError = document.getElementById('nails-error');

      // Refer√™ncias para o loading e texto do bot√£o
      // CORRE√á√ÉO: Pega a refer√™ncia correta do loading spinner e dos textos
      const loadingSpinner = document.getElementById('loading-spinner');
      const buttonTextNext = document.getElementById('button-text-next');
      const buttonTextGenerate = document.getElementById('button-text-generate');
      const comparisonAnalysisResult = document.getElementById('comparison-analysis-result');
      
      const continueToShapeMeasurement = document.getElementById('continue-to-shape-measurement');
      const continueToRatioMeasurement = document.getElementById('continue-to-ratio-measurement');
      const backFromLegalButton = document.getElementById('back-from-legal-button');
      
      // NOVO: Bot√µes de voltar dentro dos blocos (agora todos no rodap√©)
      const backShapeInstruction = document.getElementById('back-shape-instruction');
      const backMeasurement = document.getElementById('back-measurement');
      const backShapeResult = document.getElementById('back-shape-result');
      const backRatioInstruction = document.getElementById('back-ratio-instruction');
      const backRatioResult = document.getElementById('back-ratio-result');
      const backNailsQuestion = document.getElementById('back-nails-question');
      const backFromReportButton = document.getElementById('back-from-report-button');


      const canvas = document.getElementById('imageCanvas');
      const ctx = canvas.getContext('2d');
      const goldenRatioIdeal = 1.618;

      // --- Vari√°veis de Estado Relacional ---
      let points = [];
      let currentStep = 1;
      let img = new Image();
      let imageUrl = '';
      let currentAnalysisPhase = 'shape';
      let nameP1 = '';
      let nameP2 = '';
      let currentPerson = 'P1'; // 'P1' ou 'P2'
      // O objeto de dados n√£o precisa mais de q1, q2, q3, q4
      let analysisDataP1 = {unhas: '', finalImage: ''}; 
      let analysisDataP2 = {unhas: '', finalImage: ''};
      let currentRotation = 0;
      let currentActiveBlockId = 'splash-screen'; // NOVO: Armazena o ID do bloco atual para l√≥gica de navega√ß√£o

      // --- Elementos do Preview/Giro ---
      const photoPreview = document.getElementById('photo-preview');
      const retakePhotoButton = document.getElementById('retake-photo-button');
      const usePhotoButton = document.getElementById('use-photo-button');
      const rotateLeftButton = document.getElementById('rotate-left-button');
      const rotateRightButton = document.getElementById('rotate-right-button');
      const cameraError = document.getElementById('camera-error');
      
      const shapeStepLabels = ['Ponta do H√°lux', 'Ponta do 2¬∫ Dedo', 'Ponta do 3¬∫ Dedo', 'Ponta do 5¬∫ Dedo'];
      const ratioStepLabels = ['Ponta do 2¬∫ Dedo', 'In√≠cio do 2¬∫ Dedo', 'Fim do Peito do P√©'];
      
      // Mapeamento de texto para emoji
      const shapeEmojis = {
          'Eg√≠pcio': 'üöÑ', // CORRIGIDO
          'Grego/Romano': 'üóÇÔ∏è', // CORRIGIDO
          'Quadrado': 'üåÖ' // CORRIGIDO
      };

      // --- Fun√ß√µes Auxiliares de Formato ---
      
      function formatName(name) {
          if (!name) return '';
          return name.charAt(0).toUpperCase() + name.slice(1);
      }

      function isEgyptianHarmonic(L1, L2, L3, L5) {
          if (L1 > L2 * 1.07 && L1 > L5) {
              const d1 = L1 - L2;
              const d2 = L2 - L3;
              if (L2 > L3 && Math.abs(d1 - d2) / Math.max(d1, d2, 1) < 0.6) {
                  return true;
              }
              if (L1 > L2 * 1.2 && L1 > L5 * 1.2) {
                   return true;
              }
          }
          return false;
      }

      function isSquareFoot(L1, L2, L3, L5) {
          const max = Math.max(L1, L2, L3); 
          const min = Math.min(L1, L2, L3);
          const range = max - min;
          if (range / min <= 0.08) return true;
          if (L2 > L1 && L2 > L3 && Math.abs(L1 - L3) / Math.min(L1, L3, 1) < 0.15) return true;
          return false;
      }
      
      function isMobileDevice() {
          return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      }

      function setupEnvironment() {
          const isMobile = isMobileDevice();
          const openCameraButtonLabel = document.getElementById('open-camera-button-label');

          if (isMobile) {
              openCameraButtonLabel.classList.remove('hidden');
              cameraError.classList.add('hidden');
          } else {
              openCameraButtonLabel.classList.add('hidden');
              cameraError.classList.remove('hidden');
              cameraError.textContent = 'A fun√ß√£o "Tirar Foto" est√° dispon√≠vel apenas em dispositivos m√≥veis. Por favor, use o bot√£o "Fazer Upload" no computador.';
          }
      }
      
      // REMOVIDO: Fun√ß√£o setupNavigationButtons, pois a navega√ß√£o √© interna
      
      function showBlock(blockToShow) {
        const allBlocks = [splashScreen, personalizationBlock, uploadBlock, shapeInstructionBlock, ratioInstructionBlock, measurementBlock, shapeResultBlock, ratioResultBlock, nailsQuestionBlock, comparisonReportBlock, previewBlock, legalDocumentsBlock];
        
        // NOVO: Renderiza an√∫ncios ao mostrar o bloco de Personaliza√ß√£o
        if (blockToShow === personalizationBlock) {
            // renderAd('ads-personalization'); // Adicionar div se usar AdSense manual
        } 

        // Adiciona a classe 'hiding' ao bloco ativo atual
        allBlocks.forEach(block => {
          if (block && block.classList.contains('active-block')) {
            block.classList.add('hiding');
          }
        });

        const targetId = blockToShow ? blockToShow.id : null;

        setTimeout(() => {
          // Remove as classes de transi√ß√£o e ativo de todos os blocos
          allBlocks.forEach(block => {
            if (block) block.classList.remove('active-block', 'hiding');
          });
          // Ativa o bloco de destino
          if (blockToShow) blockToShow.classList.add('active-block');
          
          currentActiveBlockId = targetId; // Atualiza o ID do bloco ativo
          
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 300);
      }

      function processImageAndContinue(dataUrl) {
        img.onload = () => {
            const maxWidth = 800, maxHeight = 600;
            let { width, height } = img;
            const aspectRatio = img.width / img.height;
            if (img.width > maxWidth || img.height > maxHeight) {
                if (aspectRatio > 1) { width = maxWidth; height = width / aspectRatio; } 
                else { height = maxHeight; width = height * aspectRatio; }
            }
            canvas.width = width;
            canvas.height = height;
            
            photoPreview.src = dataUrl;
            imageUrl = dataUrl;
            currentRotation = 0;
            photoPreview.style.transform = 'rotate(0deg)';
            
            // CORRE√á√ÉO: Atualiza o nome de destino na tela de confirma√ß√£o
            document.getElementById('preview-target-name').textContent = formatName(currentPerson === 'P1' ? nameP1 : nameP2);
            showBlock(previewBlock);
        };
        img.src = dataUrl;
      }
      
      // Fun√ß√£o para iniciar o fluxo de medi√ß√£o para o Formato
      function startShapeAnalysis(imageOverrideUrl = imageUrl) { 
          currentAnalysisPhase = 'shape'; 
          points = []; 
          currentStep = 1; 
          
          const targetName = currentPerson === 'P1' ? nameP1 : nameP2;
          document.getElementById('shape-target-name').textContent = formatName(targetName);
          document.getElementById('ratio-target-name').textContent = formatName(targetName);
          document.getElementById('measurement-target-name').textContent = formatName(targetName);
          
          img.onload = () => {
              showBlock(shapeInstructionBlock); 
          };
          img.src = imageOverrideUrl;
      }
      
      // Fun√ß√£o para iniciar o fluxo de medi√ß√£o para o Tamanho dos Dedos
      function startRatioAnalysis() { 
          currentAnalysisPhase = 'ratio'; 
          points = []; 
          currentStep = 1; 
          showBlock(ratioInstructionBlock); 
      }
      
      // Fun√ß√£o para atualizar a UI do bloco de medi√ß√£o
      function updateUI() {
        const labels = currentAnalysisPhase === 'shape' ? shapeStepLabels : ratioStepLabels;
        const buttonText = currentAnalysisPhase === 'shape' ? 'Calcular Formato' : 'Calcular An√°lise do Tamanho dos Dedos';
        document.getElementById('instruction').textContent = currentStep <= labels.length ? `Clique para marcar o ponto ${currentStep}: ${labels[currentStep - 1]}` : `Marca√ß√µes conclu√≠das. Clique em "${buttonText}".`;
        
        // Ajusta a visibilidade do bot√£o de Calcular (Rodap√© √† direita)
        const calculateButtonElement = document.getElementById('calculate-button');
        calculateButtonElement.classList.toggle('hidden', currentStep <= labels.length);
        calculateButtonElement.textContent = buttonText;
        
        canvas.classList.toggle('custom-cursor', currentStep <= labels.length);
        const progressContainer = document.getElementById('progress-container');
        progressContainer.innerHTML = '';
        progressContainer.className = `mt-4 grid gap-2 grid-cols-${labels.length}`;
        labels.forEach((label, index) => {
          const isCompleted = index < currentStep - 1, isCurrent = index === currentStep - 1;
          const bgColor = isCompleted ? 'bg-green-100 border-green-300 text-green-800' : isCurrent ? 'bg-blue-100 border-blue-300 text-blue-800' : 'bg-gray-100 border-gray-300 text-gray-600';
          progressContainer.innerHTML += `<div class="p-2 text-sm rounded-lg border text-center ${bgColor}">${index + 1}. ${label}</div>`;
        });
      }

      // Fun√ß√£o de Desenho no Canvas (CORRIGIDA)
      function drawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        if (currentAnalysisPhase === 'shape') {
          const refY = canvas.height / 2;
          ctx.beginPath(); ctx.moveTo(0, refY); ctx.lineTo(canvas.width, refY);
          Object.assign(ctx, { strokeStyle: 'rgba(239, 68, 68, 0.1)', lineWidth: 3 }).setLineDash([5, 5]); ctx.stroke(); ctx.setLineDash([]);
        } 
        
        if (currentAnalysisPhase === 'ratio' && points.length >= 2) {
            // Desenha a linha Ponta do 2¬∫ dedo (P1) at√© Base do 2¬∫ dedo (P2)
            ctx.beginPath(); 
            ctx.moveTo(points[0].x, points[0].y); 
            ctx.lineTo(points[1].x, points[1].y);
            Object.assign(ctx, { strokeStyle: '#ef4444', lineWidth: 3 }).stroke();

            // CORRE√á√ÉO: S√≥ desenha a segunda linha se o terceiro ponto j√° existir
            if (points.length >= 3) {
              // Desenha a linha Base do 2¬∫ dedo (P2) at√© Fim do Peito do P√© (P3)
              ctx.beginPath(); 
              ctx.moveTo(points[1].x, points[1].y); 
              ctx.lineTo(points[2].x, points[2].y);
              Object.assign(ctx, { strokeStyle: '#3b82f6', lineWidth: 3 }).setLineDash([5, 5]); 
              ctx.stroke(); 
              ctx.setLineDash([]);
            }
        }
        
        points.forEach((point, index) => {
          if (currentAnalysisPhase === 'shape') {
            const refY = canvas.height / 2;
            ctx.beginPath(); ctx.moveTo(point.x, point.y); ctx.lineTo(point.x, refY);
            Object.assign(ctx, { strokeStyle: 'rgba(255, 0, 0, 0.6)', lineWidth: 3 }).stroke();
            if (index > 0) {
              ctx.beginPath(); ctx.moveTo(points[index-1].x, points[index-1].y); ctx.lineTo(point.x, point.y);
              Object.assign(ctx, { strokeStyle: 'rgba(0, 0, 255, 0.3)', lineWidth: 2 }).stroke();
            }
            const lengthValue = Math.abs(point.y - refY).toFixed(0);
            Object.assign(ctx, { fillStyle: '#ff0000', font: 'bold 12px Arial' }).fillText(`${lengthValue}px`, point.x + 10, (point.y + refY) / 2);
          } 
          
          ctx.beginPath(); ctx.arc(point.x, point.y, 8, 0, 2 * Math.PI);
          Object.assign(ctx, { fillStyle: currentAnalysisPhase === 'ratio' ? (index < 2 ? '#ef4444' : '#3b82f6') : '#ff0000' }).fill();
          Object.assign(ctx, { strokeStyle: '#ffffff', lineWidth: 2 }).stroke();
          Object.assign(ctx, { fillStyle: '#ffffff', font: 'bold 14px Arial', textAlign: 'center' }).fillText(index + 1, point.x, point.y + 4);
        });
      }
      
      // Fun√ß√£o para salvar o resultado da fase (Formato ou Ratio)
      function saveAnalysisResult(type, result) {
          const targetData = currentPerson === 'P1' ? analysisDataP1 : analysisDataP2;
          
          if (type === 'shape') {
              targetData.shape = result;
              targetData.shapeImage = imageUrl; // Salva a imagem final da Pessoa 1
              if (currentPerson === 'P2') {
                  targetData.shapeImage = imageUrl; // Salva a imagem final da Pessoa 2
              }
          } else if (type === 'ratio') {
              targetData.ratio = result;
          } else if (type === 'questions') {
              // Agora, 'result' cont√©m apenas { unhas: X, finalImage: Y }
              Object.assign(targetData, result);
          }
          
          if (currentPerson === 'P1') { analysisDataP1 = targetData; } 
          else { analysisDataP2 = targetData; }
      }

      // Classifica Formato e salva
      function classifyShape() {
        if (points.length < 4) return;
        const refY = canvas.height / 2;
        const [L1, L2, L3, L5] = [
            Math.abs(points[0].y - refY), Math.abs(points[1].y - refY), 
            Math.abs(points[2].y - refY), Math.abs(points[3].y - refY)
        ];
        let shapeText, shapeEmoji, reasoning;
        
        if (isEgyptianHarmonic(L1, L2, L3, L5)) {
            [shapeText, shapeEmoji, reasoning] = ['Eg√≠pcio', shapeEmojis.Eg√≠pcio, 'O ded√£o √© dominante e h√° uma progress√£o de decl√≠nio percept√≠vel nos dedos adjacentes, indicando predomin√¢ncia do pensamento linear e organiza√ß√£o.'];
        } else if (isSquareFoot(L1, L2, L3, L5)) {
            [shapeText, shapeEmoji, reasoning] = ['Quadrado', shapeEmojis.Quadrado, 'Os dedos centrais t√™m tamanhos muito semelhantes, com pouca varia√ß√£o, sugerindo uma estrutura de pensamento digital, com foco na integra√ß√£o e coer√™ncia entre as partes.'];
        } else {
            [shapeText, shapeEmoji, reasoning] = ['Grego/Romano', shapeEmojis['Grego/Romano'], 'O formato apresenta uma sequ√™ncia que n√£o se encaixa nos padr√µes Eg√≠pcio ou Quadrado, sendo classificado como uma varia√ß√£o do p√© Grego/Romano, com tend√™ncia ao pensamento sist√™mico e √† vis√£o global dos processos.'];
        }
        
        saveAnalysisResult('shape', shapeText);
        
        document.getElementById('shape-result-target-name').textContent = formatName(currentPerson === 'P1' ? nameP1 : nameP2);
        document.getElementById('shape-text').textContent = shapeText;
        document.getElementById('shape-emoji').textContent = shapeEmoji;
        document.getElementById('classification-reasoning').textContent = reasoning;
        document.getElementById('shape-result-image').src = imageUrl;
        showBlock(shapeResultBlock);
      }
      
      // Classifica Tamanho Dedos e salva
      function classifyRatio(ratio) {
        const diff = Math.abs(ratio - goldenRatioIdeal) / goldenRatioIdeal;
        let classification;
        if (diff <= 0.05) { classification = { text: 'Normais (An√°lise do Tamanho dos Dedos)', color: 'result-perfect' }; }
        else if (ratio <= 2.0) { classification = { text: 'Dedos Longos', color: 'result-very-close' }; }
        else if (ratio >= 3.0) { classification = { text: 'Dedos Curtos', color: 'result-far' }; }
        else { classification = ratio > 2.5 ? { text: 'Normais para Curtos', color: 'result-close' } : { text: 'Normais para Longos', color: 'result-close' }; }
        
        saveAnalysisResult('ratio', classification.text);
        
        document.getElementById('ratio-result-target-name').textContent = formatName(currentPerson === 'P1' ? nameP1 : nameP2);
        document.getElementById('ratio-result-ratio').textContent = ratio.toFixed(3);
        document.getElementById('ratio-result-ratio').className = `text-5xl font-extrabold mb-4 ${classification.color}`;
        document.getElementById('ratio-result-text').textContent = classification.text;
        document.getElementById('ratio-result-image').src = imageUrl;
        showBlock(ratioResultBlock);
      }

      function calculateAndDisplayResult() {
        if (currentAnalysisPhase === 'ratio') {
          if (points.length < 3) return;
          const toeLength = Math.hypot(points[1].x - points[0].x, points[1].y - points[0].y);
          const footLength = Math.hypot(points[2].x - points[1].x, points[2].y - points[1].y);
          const ratio = footLength / toeLength;
          classifyRatio(ratio);
        } else if (currentAnalysisPhase === 'shape') {
            classifyShape();
        }
      }
      
      // Fun√ß√£o principal para gerar o Relat√≥rio de Compara√ß√£o
      function generateComparisonReport() {
          const p1 = analysisDataP1;
          const p2 = analysisDataP2;
          
          const name1 = formatName(nameP1);
          const name2 = formatName(nameP2);

          // Fun√ß√£o para calcular a pontua√ß√£o de match (0-10)
          function calculateMatchScore(shapeKey, ratioKey, unhasKey) {
              let score = 10;
              let frictionPoints = 0;

              // Calcula o atrito com base nos Pontos Fracos/Desafios (analise_curta)
              // 1. Formato (Pensamento)
              const shapeRel = RELATIONAL_DATA.Formato[shapeKey];
              if (shapeRel && (shapeRel.fracos.includes('rigidez') || shapeRel.fracos.includes('conflitos de controle') || shapeRel.fracos.includes('paralisia por an√°lise') || shapeRel.fracos.includes('dispers√£o'))) {
                  frictionPoints += 1.5;
              }
              // 2. Tamanho Dedos (A√ß√£o/Ritmo)
              const ratioRel = RELATIONAL_DATA['Tamanho Dedos'][ratioKey];
              if (ratioRel && (ratioRel.fracos.includes('Impaci√™ncia') || ratioRel.fracos.includes('Conflito entre a velocidade') || ratioRel.fracos.includes('pouca conex√£o com a realidade pr√°tica') || ratioRel.fracos.includes('sobrecarregado'))) {
                  frictionPoints += 1.5;
              }
              // 3. Unhas (Convic√ß√£o/Assertividade)
              const unhasRel = RELATIONAL_DATA['Tamanho das Unhas'][unhasKey];
              if (unhasRel && (unhasRel.fracos.includes('rigidez') || unhasRel.fracos.includes('conflito de poder') || unhasRel.fracos.includes('dogm√°tico') || unhasRel.fracos.includes('indecis√£o'))) {
                  frictionPoints += 2.0; // Unhas t√™m peso maior na assertividade relacional
              }
              
              // Pontua√ß√£o baseada em atrito: Max 5 pontos de atrito (Max Score √© 10)
              const finalScore = Math.max(7.5, 10 - frictionPoints); // Base m√≠nima de 7.5 para Match

              // Ajuste o score para que o m√°ximo seja 10 e o m√≠nimo seja 5.0 (garantindo que n√£o seja muito baixo)
              return Math.min(10, finalScore).toFixed(1);
          }


          // --- GERA√á√ÉO DAS CHAVES ---
          const shapeKey = sortRelationalKey(p1.shape, p2.shape);
          const ratioP1Key = RATIO_MAP[p1.ratio];
          const ratioP2Key = RATIO_MAP[p2.ratio];
          const ratioKey = sortRelationalKey(ratioP1Key, ratioP2Key);
          const unhasKey = sortRelationalKey(p1.unhas, p2.unhas);

          // --- PONTUA√á√ÉO ---
          const matchScore = calculateMatchScore(shapeKey, ratioKey, unhasKey);
          
          // --- OBTEN√á√ÉO DOS DADOS RELACIONAIS ---
          const shapeRel = RELATIONAL_DATA.Formato[shapeKey];
          const ratioRel = RELATIONAL_DATA['Tamanho Dedos'][ratioKey];
          const unhasRel = RELATIONAL_DATA['Tamanho das Unhas'][unhasKey];
          
          // Fallback para an√°lises (apenas para exibi√ß√£o)
          const shapeAnaliseCurta = shapeRel ? shapeRel.analise_curta : 'An√°lise indispon√≠vel.';
          const ratioAnaliseCurta = ratioRel ? ratioRel.analise_curta : 'An√°lise indispon√≠vel.';
          const unhasAnaliseCurta = unhasRel ? unhasRel.analise_curta : 'An√°lise indispon√≠vel.';

          // --- INJE√á√ÉO NO RELAT√ìRIO ---
          
          // CORRIGIDO: Inje√ß√£o dos nomes no cabe√ßalho
          document.getElementById('report-target-name-p1').textContent = name1;
          document.getElementById('report-target-name-p2').textContent = name2;
          
          // CORRIGIDO: Inje√ß√£o dos dados individuais
          document.getElementById('report-p1-title').textContent = `An√°lise de ${name1}`;
          document.getElementById('report-p2-title').textContent = `An√°lise de ${name2}`;
          
          document.getElementById('summary-p1-shape').textContent = p1.shape;
          document.getElementById('summary-p1-ratio').textContent = p1.ratio;
          document.getElementById('summary-p1-nails').textContent = p1.unhas;
          document.getElementById('final-report-image-p1').src = p1.finalImage; // CORRIGIDO
          
          document.getElementById('summary-p2-shape').textContent = p2.shape;
          document.getElementById('summary-p2-ratio').textContent = p2.ratio;
          document.getElementById('summary-p2-nails').textContent = p2.unhas;
          document.getElementById('final-report-image-p2').src = p2.finalImage; // CORRIGIDO

          let report = '';
          
          // T√≠tulo de Abertura
          report += `<h2 class="text-3xl font-extrabold text-gray-800 text-center mb-6">Compatibilidade dos P√©s de</h2>
                     <p class="text-2xl font-bold text-teal-600 mt-1 text-center mb-10">${name1} & ${name2}</p>
                     <p class="text-xl text-center mb-10 text-teal-600">Ser√° que d√° match? Vamos descobrir o que os p√©s indicam!</p>`; // Movido o "Ser√° que d√° match" para c√°

          // 1. Formato dos P√©s (Pensamento)
          report += `<div class="mt-4"><h4 class="text-xl font-bold text-gray-800 mb-2">Com rela√ß√£o ao formato dos p√©s:</h4>`;
          // CORRE√á√ÉO: Removendo par√™nteses dos nomes e mantendo a formata√ß√£o X
          report += `<p class="mb-1 font-semibold">${name1}=${p1.shape} √ó ${name2}=${p2.shape}</p>`;
          report += `<p class="mb-4">${shapeAnaliseCurta}</p></div>`;

          // 2. Tamanho dos Dedos (A√ß√£o/Ritmo)
          report += `<div class="mt-4"><h4 class="text-xl font-bold text-gray-800 mb-2">Com rela√ß√£o ao tamanho dos dedos:</h4>`;
          // CORRE√á√ÉO: Removendo par√™nteses dos nomes e prefixando 'dedos'
          report += `<p class="mb-1 font-semibold">${name1}=dedos ${ratioP1Key} √ó ${name2}=dedos ${ratioP2Key}</p>`;
          report += `<p class="mb-4">${ratioAnaliseCurta}</p></div>`;

          // 3. Tamanho das Unhas (Convic√ß√£o)
          report += `<div class="mt-4"><h4 class="text-xl font-bold text-gray-800 mb-2">Com rela√ß√£o ao tamanho das Unhas:</h4>`;
          // CORRE√á√ÉO: Removendo par√™nteses dos nomes
          report += `<p class="mb-1 font-semibold">${name1}=${p1.unhas} √ó ${name2}=${p2.unhas}</p>`;
          report += `<p class="mb-4">${unhasAnaliseCurta}</p></div>`;
          
          // Resultado Final ‚Äî O Veredito dos P√©s
          report += `<div class="mt-8 pt-4 border-t-2 border-gray-300">
              <h4 class="text-2xl font-extrabold text-red-700 text-center mb-4">Resultado Final ‚Äî O Veredito dos P√©s:</h4>
              
              <div class="text-center bg-green-50 p-6 rounded-lg shadow-md mb-8">
                  <p class="text-lg font-semibold text-gray-800 mb-3">${name1} & ${name2} t√™m tudo para se entender bem ‚Äî s√£o parecidos na cabe√ßa, complementares na a√ß√£o e desafiadores nas convic√ß√µes.</p>
                  <p class="text-lg font-semibold text-gray-800">Quando equilibram mente, ritmo e firmeza, o relacionamento flui com maturidade e leveza.</p>
              </div>

              <!-- Pontua√ß√£o Visual -->
              <div class="text-center">
                  <p class="text-4xl font-extrabold text-teal-600">${matchScore} / 10</p>
                  <p class="text-lg font-bold text-gray-700 mb-6">Compatibilidade Geral</p>
                  <div class="relative w-full max-w-sm mx-auto h-3 bg-gray-200 rounded-full">
                      <div class="absolute h-3 rounded-full bg-teal-500 transition-all duration-1000" style="width: ${matchScore * 10}%;"></div>
                  </div>
              </div>

              <p class="text-center text-lg font-semibold text-gray-700 mt-6">Um match com √≥timo potencial ‚Äî basta que cada um aprenda o passo do outro.</p>
              
              <div class="mt-8 pt-4 border-t border-teal-200">
                  <h4 class="text-xl font-bold text-teal-800 mb-2">A F√≥rmula de Compatibilidade</h4>
                  <p class="text-sm leading-relaxed">
                      A uni√£o √© a arte de harmonizar as diferen√ßas. Onde h√° Pontos Fortes, existe fluidez e seguran√ßa e onde h√° Pontos Fracos, existe um convite para o crescimento. Os p√©s revelam que, para ${name1} e ${name2} prosperarem, √© crucial que ambos se dediquem a compreender e respeitar o ritmo de pensamento e a rigidez de convic√ß√£o um do outro.
                  </p>
              </div>
          </div>
          
          <!-- Assinatura -->
          <p class="mt-4 text-right text-xs">Fraternos Abra√ßos!<br><strong>Irmo Zuccato Neto</strong></p>`;
          
          comparisonAnalysisResult.innerHTML = report;
          showBlock(comparisonReportBlock);
          loadingSpinner.classList.add('hidden');
          // continueToNextStep √© o bot√£o de a√ß√£o principal, ent√£o ele precisa ser reativado
          if (continueToNextStep) continueToNextStep.disabled = false;
      }
      
      // Fun√ß√µes de Inicializa√ß√£o/Reset (Adaptadas ao fluxo P1/P2)
      function startNewAnalysis() {
        // As respostas agora s√£o apenas unhas e a imagem
        analysisDataP1 = {unhas: '', finalImage: ''}; 
        analysisDataP2 = {unhas: '', finalImage: ''};
        nameP1 = ''; nameP2 = '';
        currentPerson = 'P1'; 
        
        // Zera os inputs de nome
        document.getElementById('name-p1-input').value = '';
        document.getElementById('name-p2-input').value = '';
        
        // Reset do bot√£o final
        if (buttonTextNext) buttonTextNext.classList.remove('hidden');
        if (buttonTextGenerate) buttonTextGenerate.classList.add('hidden');
        if (continueToNextStep) continueToNextStep.textContent = 'Prosseguir para a An√°lise da Pessoa 2';
        
        setupEnvironment(); 
        showBlock(personalizationBlock);
      }
      
      function continueToNextPerson() {
          currentPerson = 'P2';
          
          // Troca o texto do bot√£o para "Gerar Relat√≥rio"
          if (buttonTextNext) buttonTextNext.classList.add('hidden');
          if (buttonTextGenerate) buttonTextGenerate.classList.remove('hidden');
          
          // Vai para a tela de Upload do P√© 2
          let nameForDisplay = nameP2;
          document.getElementById('target-name-display').textContent = formatName(nameForDisplay);
          
          // Limpa a sele√ß√£o de unhas para a pr√≥xima pessoa
          document.querySelectorAll('input[name="nails-visibility"]').forEach(radio => radio.checked = false);
          document.querySelectorAll('#nails-question-block label').forEach(label => label.classList.remove('border-purple-500', 'bg-purple-100')); 
          
          showBlock(uploadBlock);
      }
      
      // NOVO: Fun√ß√£o para Voltar (Go Back) - L√≥gica do fluxo
      function goBack() {
        switch (currentActiveBlockId) {
            case shapeInstructionBlock.id:
                // Da instru√ß√£o de formato, volta para a tela de pr√©via/foto
                showBlock(previewBlock);
                break;
            case measurementBlock.id:
                // Da medi√ß√£o (Shape ou Ratio), volta para a instru√ß√£o anterior
                if (currentAnalysisPhase === 'shape') {
                    showBlock(shapeInstructionBlock);
                } else {
                    showBlock(ratioInstructionBlock);
                }
                break;
            case shapeResultBlock.id:
                // Do resultado do formato, volta para a medi√ß√£o do formato
                showBlock(measurementBlock);
                // Configura o bloco de medi√ß√£o para a fase de formato
                currentAnalysisPhase = 'shape'; 
                updateUI();
                break;
            case ratioInstructionBlock.id:
                // Da instru√ß√£o de ratio, volta para o resultado do formato
                showBlock(shapeResultBlock);
                break;
            case ratioResultBlock.id:
                // Do resultado do ratio, volta para a medi√ß√£o do ratio
                showBlock(measurementBlock);
                // Configura o bloco de medi√ß√£o para a fase de ratio
                currentAnalysisPhase = 'ratio';
                updateUI();
                break;
            case nailsQuestionBlock.id:
                // Da an√°lise de unhas, volta para o resultado do ratio
                showBlock(ratioResultBlock);
                break;
            case uploadBlock.id:
                 // Se estiver no upload do P2, volta para a an√°lise de unhas do P1
                if (currentPerson === 'P2') {
                    currentPerson = 'P1';
                    showBlock(nailsQuestionBlock);
                    // Restaura o estado visual do bot√£o para P1 (pr√≥ximo √© P2)
                    if (buttonTextNext) buttonTextNext.classList.remove('hidden');
                    if (buttonTextGenerate) buttonTextGenerate.classList.add('hidden');
                } else {
                    // Se estiver no upload do P1, volta para a tela de nomes
                    showBlock(personalizationBlock);
                }
                break;
            case previewBlock.id:
                // Da pr√©via, volta para o upload (permite trocar a foto)
                showBlock(uploadBlock);
                break;
            case comparisonReportBlock.id:
                // Do relat√≥rio final, volta para as unhas do P2
                currentPerson = 'P2';
                // Restaura o estado visual do bot√£o para P2 (pr√≥ximo √© Relat√≥rio)
                if (buttonTextNext) buttonTextNext.classList.add('hidden');
                if (buttonTextGenerate) buttonTextGenerate.classList.remove('hidden');
                showBlock(nailsQuestionBlock);
                break;
            default:
                // Para splash/personalization/legal (que n√£o t√™m bot√£o de voltar no flow)
                console.warn(`A√ß√£o de voltar n√£o definida para o bloco: ${currentActiveBlockId}`);
                break;
        }
      }

      // --- Event Listeners ---
      if(startButton) startButton.addEventListener('click', () => { 
          setupEnvironment(); 
          showBlock(personalizationBlock); 
          setTimeout(() => {
              if (splashScreen) splashScreen.remove();
              if (appHeaderContainer) appHeaderContainer.remove(); 
          }, 400); 
      });
      
      if(continueToUploadButton) continueToUploadButton.addEventListener('click', () => { 
          nameP1 = document.getElementById('name-p1-input').value.trim();
          nameP2 = document.getElementById('name-p2-input').value.trim();
          const errorEl = document.getElementById('personalization-error');
          
          if (!nameP1 || !nameP2) return errorEl.classList.remove('hidden');
          
          errorEl.classList.add('hidden');
          document.getElementById('target-name-display').textContent = formatName(nameP1);
          document.getElementById('preview-target-name').textContent = formatName(nameP1);
          showBlock(uploadBlock);
      });
      
      // Listener para o input de foto/upload
      if(nativeCameraInput) nativeCameraInput.addEventListener('change', e => e.target.files[0] && (reader => { 
          reader.onload = evt => { e.target.value = ''; processImageAndContinue(evt.target.result); }; 
          reader.readAsDataURL(e.target.files[0]); 
      })(new FileReader()));
      if(imageUpload) imageUpload.addEventListener('change', e => e.target.files[0] && (reader => { 
          reader.onload = evt => { e.target.value = ''; processImageAndContinue(evt.target.result); }; 
          reader.readAsDataURL(e.target.files[0]); 
      })(new FileReader()));


      if(canvas) canvas.addEventListener('click', e => {
        const labels = currentAnalysisPhase === 'shape' ? shapeStepLabels : ratioStepLabels;
        if (currentStep > labels.length) return;
        const rect = canvas.getBoundingClientRect();
        points.push({ x: (e.clientX - rect.left) * (canvas.width / rect.width), y: (e.clientY - rect.top) * (canvas.height / rect.height) });
        currentStep++; drawCanvas(); updateUI();
        if (currentStep > labels.length) {
          canvas.classList.remove('custom-cursor');
          setTimeout(calculateAndDisplayResult, 600);
        }
      });
      
      if(calculateButton) calculateButton.addEventListener('click', calculateAndDisplayResult);
      if(redoButton) redoButton.addEventListener('click', () => { points = []; currentStep = 1; canvas.classList.add('custom-cursor'); drawCanvas(); updateUI(); showBlock(measurementBlock); });
      if(continueToShapeMeasurement) continueToShapeMeasurement.addEventListener('click', () => { showBlock(measurementBlock); drawCanvas(); updateUI(); });
      if(analyzeRatioButton) analyzeRatioButton.addEventListener('click', startRatioAnalysis);
      if(continueToRatioMeasurement) continueToRatioMeasurement.addEventListener('click', () => { showBlock(measurementBlock); drawCanvas(); updateUI(); });
      
      if(newRatioAnalysisButton) newRatioAnalysisButton.addEventListener('click', () => { 
          const targetName = currentPerson === 'P1' ? nameP1 : nameP2;
          document.getElementById('nails-result-image').src = imageUrl;
          document.getElementById('nails-target-name').textContent = formatName(targetName);
          showBlock(nailsQuestionBlock); 
      });
      
      // NOVO FLUXO (Substitui 'continueToPersonalQuestions' e 'nextPersonButton')
      if(continueToNextStep) continueToNextStep.addEventListener('click', () => {
          const unhas = document.querySelector('input[name="nails-visibility"]:checked'); 
          if (!unhas) return document.getElementById('nails-error').classList.remove('hidden');
          
          document.getElementById('nails-error').classList.add('hidden');
          
          // 1. Salva a escolha da unha (e final image) no objeto de dados atual
          saveAnalysisResult('questions', { unhas: unhas.value, finalImage: imageUrl }); 

          // 2. Inicia estado de loading
          loadingSpinner.classList.remove('hidden');
          continueToNextStep.disabled = true;

          // 3. Transi√ß√£o P1 -> P2 ou Gera√ß√£o de Relat√≥rio (P2)
          if (currentPerson === 'P1') {
              // P1 terminou. Prepara para ir para P2.
              
              setTimeout(() => {
                  loadingSpinner.classList.add('hidden');
                  continueToNextStep.disabled = false;
                  continueToNextPerson(); // Chama a fun√ß√£o que troca a pessoa e mostra o upload
              }, 1000);
              
          } else { // currentPerson === 'P2'
              // P2 terminou. Gera o relat√≥rio.
              
              // Atualiza o texto do bot√£o (visualmente)
              if (buttonTextNext) buttonTextNext.classList.add('hidden');
              if (buttonTextGenerate) buttonTextGenerate.classList.remove('hidden');
              
              setTimeout(() => {
                  generateComparisonReport();
                  // Reset: button state
                  loadingSpinner.classList.add('hidden');
                  continueToNextStep.disabled = false;
                  // Reinicia a visualiza√ß√£o do bot√£o para um poss√≠vel novo ciclo
                  if (buttonTextNext) buttonTextNext.classList.remove('hidden');
                  if (buttonTextGenerate) buttonTextGenerate.classList.add('hidden');
              }, 1500); 
          }
      });
      
      if(startNewFullAnalysisButton) startNewFullAnalysisButton.addEventListener('click', startNewAnalysis);
      
      // Preview/Rotate logic (mantido)
      if(rotateLeftButton) rotateLeftButton.addEventListener('click', () => { currentRotation = (currentRotation - 90) % 360; photoPreview.style.transform = `rotate(${currentRotation}deg)`; });
      if(rotateRightButton) rotateRightButton.addEventListener('click', () => { currentRotation = (currentRotation + 90) % 360; photoPreview.style.transform = `rotate(${currentRotation}deg)`; });
      if(usePhotoButton) usePhotoButton.addEventListener('click', () => { 
        if (!photoPreview.src) return;
        
        if (currentRotation !== 0) {
          const tempCanvas = document.createElement('canvas');
          const tempCtx = tempCanvas.getContext('2d');
          const tempImg = new Image();
          tempImg.onload = () => {
            if (currentRotation === 90 || currentRotation === -270 || currentRotation === 270 || currentRotation === -90) {
              tempCanvas.width = tempImg.height; tempCanvas.height = tempImg.width;
            } else {
              tempCanvas.width = tempImg.width; tempCanvas.height = tempImg.height;
            }
            tempCtx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
            tempCtx.rotate((currentRotation * Math.PI) / 180);
            tempCtx.drawImage(tempImg, -tempImg.width / 2, -tempImg.height / 2);
            const rotatedImageData = tempCanvas.toDataURL('image/jpeg', 0.9);
            currentRotation = 0; photoPreview.style.transform = 'rotate(0deg)';
            startShapeAnalysis(rotatedImageData);
          };
          tempImg.src = photoPreview.src;
        } else {
          startShapeAnalysis(photoPreview.src);
        }
      });
      
      // Listener para r√°dio buttons de unhas (mantido)
      document.querySelectorAll('#nails-question-block label').forEach(label => label.addEventListener('click', function() { 
          const input = this.querySelector('input[type="radio"]'); 
          if(input) { 
              document.querySelectorAll(`input[name="${input.name}"]`).forEach(r => r.parentElement.classList.remove('border-purple-500', 'bg-purple-100')); 
              this.classList.add('border-purple-500', 'bg-purple-100'); 
              input.checked = true; 
          } 
      }));


      // Listeners para a se√ß√£o legal (mantidos)
      const openTermsLinks = document.querySelectorAll('#open-terms-splash, #open-terms-personalization');
      openTermsLinks.forEach(link => {
          link.addEventListener('click', (e) => {
              e.preventDefault();
              showBlock(legalDocumentsBlock);
          });
      });
      if(backFromLegalButton) backFromLegalButton.addEventListener('click', () => {
          // O fluxo legal n√£o muda o activeBlockId, ent√£o ele volta para o √∫ltimo bloco normal.
          const lastNormalBlock = document.getElementById(currentActiveBlockId);
          if (lastNormalBlock) { showBlock(lastNormalBlock); } 
          else { showBlock(personalizationBlock); }
      });
      
      
      const saveAnalysisButton = document.getElementById('save-analysis-button');
      const shareAnalysisButton = document.getElementById('share-analysis-button'); // Novo bot√£o
      
      async function generateAndSavePDF(actionType = 'save') {
        const reportElement = document.getElementById('comparison-report-block');
        const filename = `Analise_Relacional_${formatName(nameP1)}_e_${formatName(nameP2)}.pdf`;

        // Determina qual bot√£o desabilitar/mudar texto
        const buttonToUpdate = actionType === 'share' ? shareAnalysisButton : saveAnalysisButton;
        const originalText = buttonToUpdate.textContent;
        buttonToUpdate.textContent = 'Gerando Arquivo...';
        buttonToUpdate.disabled = true;
        saveAnalysisButton.disabled = true; // Desabilita ambos durante a gera√ß√£o
        shareAnalysisButton.disabled = true;

        const originalParent = reportElement.parentNode;
        const originalNextSibling = reportElement.nextSibling;
        const originalStyle = reportElement.style.cssText;
        const originalClassList = Array.from(reportElement.classList);
        
        reportElement.classList.remove('active-block', 'step-container', 'hiding');
        Object.assign(reportElement.style, {
            position: 'static', display: 'block', opacity: '1', transform: 'none', transition: 'none',
            width: '100%', maxWidth: '100%', margin: '0', padding: '25px', boxShadow: 'none',
            border: 'none', boxSizing: 'border-box'
        });

        document.body.appendChild(reportElement);
        
        const actionButtons = reportElement.querySelector('.action-buttons');
        const originalActionButtonsDisplay = actionButtons ? actionButtons.style.display : null;
        if (actionButtons) actionButtons.style.display = 'none';
        
        const originalAppMainDisplay = appMainContent.style.display;
        appMainContent.style.display = 'none';
        
        let pdfBlob = null;

        try {
            await new Promise(resolve => setTimeout(resolve, 300));
            
            const opt = {
              margin: [10, 10, 10, 10], filename: filename, image: { type: 'jpeg', quality: 0.95 },
              html2canvas: { scale: 1.5, useCORS: true, logging: false, scrollX: 0, scrollY: 0, windowWidth: document.documentElement.scrollWidth },
              jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', compress: true },
              pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };
            
            const worker = html2pdf().from(reportElement).set(opt);
            
            if (actionType === 'save') {
                await worker.save();
            } else if (actionType === 'share') {
                pdfBlob = await worker.output('blob');
            }

        } catch (err) {
            console.error("Erro ao gerar PDF:", err);
        } finally {
            // Restaura o DOM
            if (originalNextSibling) { originalParent.insertBefore(reportElement, originalNextSibling); } 
            else if (originalParent) { originalParent.appendChild(reportElement); }

            reportElement.style.cssText = originalStyle;
            reportElement.className = ''; 
            originalClassList.forEach(cls => reportElement.classList.add(cls)); 
            
            if (actionButtons) actionButtons.style.display = originalActionButtonsDisplay;
            appMainContent.style.display = originalAppMainDisplay;

            // Restaura os bot√µes
            saveAnalysisButton.textContent = 'Salvar Relat√≥rio em PDF';
            shareAnalysisButton.textContent = 'Compartilhar Resultado';
            saveAnalysisButton.disabled = false;
            shareAnalysisButton.disabled = false;
            
            // Tenta o compartilhamento
            if (actionType === 'share' && pdfBlob) {
                if (navigator.share) {
                    const file = new File([pdfBlob], filename, { type: 'application/pdf' });
                    try {
                        await navigator.share({
                            files: [file],
                            title: `An√°lise de Match - ${name1} & ${name2}`,
                            text: `Confira a an√°lise de compatibilidade dos p√©s de ${name1} e ${name2}!`
                        });
                    } catch (error) {
                        if (error.name !== 'AbortError') {
                            console.error('Erro ao compartilhar:', error);
                            // Usar console.log ou um modal customizado, n√£o alert().
                        }
                    }
                } else {
                    // Usar console.log ou um modal customizado, n√£o alert().
                }
            }
        }
      }

      if(saveAnalysisButton) saveAnalysisButton.addEventListener('click', () => generateAndSavePDF('save'));
      if(shareAnalysisButton) shareAnalysisButton.addEventListener('click', () => generateAndSavePDF('share'));
      
      // Chamada da fun√ß√£o de setup na inicializa√ß√£o e ao mudar de tela
      document.addEventListener('DOMContentLoaded', startNewAnalysis);
      
      // --- Adiciona Listeners para a navega√ß√£o de Voltar ---
      // Eles j√° chamam goBack(), que cont√©m a l√≥gica de navega√ß√£o.
      if(backShapeInstruction) backShapeInstruction.addEventListener('click', goBack);
      if(backMeasurement) backMeasurement.addEventListener('click', goBack);
      if(backShapeResult) backShapeResult.addEventListener('click', goBack);
      if(backRatioInstruction) backRatioInstruction.addEventListener('click', goBack);
      if(backRatioResult) backRatioResult.addEventListener('click', goBack);
      if(backNailsQuestion) backNailsQuestion.addEventListener('click', goBack);
      if(backFromReportButton) backFromReportButton.addEventListener('click', goBack);
      
      // --- CORRE√á√ÉO: Listener para a tecla Enter ---
      document.addEventListener('keydown', e => {
        // Verifica se √© a tecla Enter
        if (e.key !== 'Enter') return;
        
        const activeElement = document.activeElement;
        
        // Exce√ß√£o: Permite Enter em campos de texto de nome (para fins de usabilidade), mas previne o Enter global.
        if (activeElement && activeElement.tagName === 'INPUT' && activeElement.type === 'text') {
            return; 
        }
        
        // Impede o Enter de submeter formul√°rios ou realizar a√ß√µes indesejadas no corpo do documento
        e.preventDefault(); 
        
        const buttonMap = [
            { b: splashScreen, i: 'start-button' },
            { b: personalizationBlock, i: 'continue-to-upload' },
            { b: previewBlock, i: 'use-photo-button' },
            { b: shapeInstructionBlock, i: 'continue-to-shape-measurement' },
            { b: shapeResultBlock, i: 'analyze-ratio-button' },
            { b: ratioInstructionBlock, i: 'continue-to-ratio-measurement' },
            // Permite calcular apenas se todos os pontos j√° foram clicados (condi√ß√£o 'c')
            { b: measurementBlock, i: 'calculate-button', c: () => calculateButton && !calculateButton.classList.contains('hidden') },
            { b: ratioResultBlock, i: 'new-ratio-analysis-button' },
            { b: nailsQuestionBlock, i: 'continue-to-next-step' },
            // NOVO: Volta para Nova An√°lise no relat√≥rio
            { b: comparisonReportBlock, i: 'start-new-full-analysis-button' }
        ];

        // Encontra o bloco ativo
        const entry = buttonMap.find(item => item.b && item.b.classList.contains('active-block'));
        
        if (entry && (!entry.c || entry.c())) { 
            const btn = document.getElementById(entry.i); 
            // Clica no bot√£o se ele existir e n√£o estiver desabilitado (ex: durante o loading)
            if (btn && !btn.disabled) { 
                btn.click();
            }
        }
    });
    });
  </script>
</body>
</html>
